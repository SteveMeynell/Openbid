<?xml version="1.0" encoding="UTF-8" ?>

<!--
// ***************************************************
//                       Weblog
//            Articles & News for Opencart	       
//
// Author : Francesco Pisanò - francesco1279@gmail.com
//              
//                   www.leverod.com		
//               © All rights reserved	  
// ***************************************************
-->

<modification>

	<id>Weblog - Articles and News for Opencart</id>
	<version>2.0.3</version>
	<vqmver>2.5.1+</vqmver>
	<author>Frank - francesco1279@gmail.com - Leverod.com</author>
	
		<file name="system/startup.php">
			<operation error="log" >
				<search position="after" ><![CDATA[error_reporting(]]></search>
				<add><![CDATA[	

				// Weblog

				require_once(VQMod::modCheck(DIR_SYSTEM . 'weblog.php'));	
					
				// END Weblog
				
				]]></add>
			</operation>
		</file>

		
<!--	
//   █████╗ ██████╗ ███╗   ███╗██╗███╗   ██╗
//  ██╔══██╗██╔══██╗████╗ ████║██║████╗  ██║
//  ███████║██║  ██║██╔████╔██║██║██╔██╗ ██║
//  ██╔══██║██║  ██║██║╚██╔╝██║██║██║╚██╗██║
//  ██║  ██║██████╔╝██║ ╚═╝ ██║██║██║ ╚████║
//  ╚═╝  ╚═╝╚═════╝ ╚═╝     ╚═╝╚═╝╚═╝  ╚═══╝
-->
	
		<!-- // Check if Weblog db installed -->
		<file name="admin/controller/common/header.php">
		
			<operation error="log">
				<search position="before" index="1"><![CDATA[class Controller]]></search>
				<add><![CDATA[
							require_once(substr_replace(DIR_SYSTEM, '/leverod/index.php', -8));	// -8 = /system/
						]]></add>
			</operation>
		
			<operation error="log">
				<search position="after"><![CDATA[function index() {]]></search>
				<add><![CDATA[
				
					// Weblog	
						if (isset($this->request->get['token']) && isset($this->session->data['token']) && ($this->request->get['token'] == $this->session->data['token'])) {
							
							$this->levLoad->levModel('user/lev_user_group');	

							$route = 'weblog/wl_startup';
							
							if(!$this->user->hasPermission('access', $route)) {
							
								$user_id = $this->user->getId();
								$this->levModel_user_lev_user_group->setPermissions(array('access'), $route, $user_id);
							}
							
							
							// Check if Weblog db installed
							$this->load->controller('weblog/wl_startup');
	
	
							$data['text_weblog']					= 'Weblog';
							$data['text_weblog_author']				= 'Authors';
							$data['text_weblog_category']			= 'Categories';
							$data['text_weblog_article']			= 'Articles';
							$data['text_weblog_article_comment']	= 'Comments';
							$data['text_weblog_view_report']		= 'Reports';
							$data['text_weblog_setting']			= 'Settings';
							$data['text_weblog_general_setting']	= 'General Settings';
							$data['text_weblog_add_modules']		= 'Add/Edit Modules';
							$data['text_weblog_backup']				= 'Backup/Restore';
					
							$data['weblog_author']				= $this->url->link('weblog/author', 'token=' . $this->session->data['token'], 'SSL');
							$data['weblog_category']			= $this->url->link('weblog/category', 'token=' . $this->session->data['token'], 'SSL');
							$data['weblog_article']				= $this->url->link('weblog/article', 'token=' . $this->session->data['token'], 'SSL');
							$data['weblog_comment']				= $this->url->link('weblog/comment', 'token=' . $this->session->data['token'], 'SSL');
							$data['weblog_general_setting']		= $this->url->link('weblog/store', 'token=' . $this->session->data['token'], 'SSL');
							$data['weblog_backup']				= $this->url->link('weblog/backup', 'token=' . $this->session->data['token'], 'SSL');
							
							$extension_page_path = version_compare(VERSION, '2.2.0.0', '<=')? 'extension/module' : 'extension/extension&type=module';
							
							$data['weblog_add_modules']			= $this->url->link($extension_page_path, 'token=' . $this->session->data['token'], 'SSL');
							$data['weblog_view_report']			= $this->url->link('weblog/report', 'token=' . $this->session->data['token'], 'SSL');
							
							$this->load->model('weblog/comment');
							$data['pending_reply_total'] = $this->model_weblog_comment->getTotalPendingComments();
						}
				// END Weblog
				
				]]></add>
			</operation>
			
			<operation error="log">
				<search position="before" index="1"><![CDATA[foreach ($results as $result) {]]></search>
				<add><![CDATA[
				
				// Weblog	
				
					$data['store_blogs'] = array();

					$data['store_blogs'][] = array(
						'store_id'	=> 0,
						'name'		=> 'Blog - ' . $this->config->get('config_name') . $this->language->get('text_default'),
						'href'		=> HTTP_CATALOG . 'index.php?route=weblog/article&weblog=0'
					);

					foreach ($results as $result) {
						$data['store_blogs'][] = array(
							'store_id'	=> $result['store_id'],
							'name'		=> 'Blog - ' . $result['name'],
							'href'		=> $result['url'] . 'index.php?route=weblog/article&weblog=' . $result['store_id']
						);
					}

				// END Weblog
				
				]]></add>
			</operation>
			
		</file>
		

		<!-- Left menu -->
	
		<file name="admin/view/template/common/header.tpl">

			<operation error="log">
				<search position="after" index="1"><![CDATA[<ul class="nav pull-right">]]></search>
				<add><![CDATA[
				
				<!-- Weblog	-->
				
				<li class="dropdown"><a class="dropdown-toggle" data-toggle="dropdown"><img style="width:80px" src="view/image/weblog-logo.gif" /></a>
					<ul class="dropdown-menu dropdown-menu-right">					
						<?php foreach ($store_blogs as $blog) { ?>
						<li><a href="<?php echo $blog['href']; ?>" target="_blank"><?php echo $blog['name']; ?></a></li>
						<?php } ?>
						
					</ul>
				</li>

				<!-- END Weblog -->
				
				]]></add>
			</operation>
		

			<operation error="log">
			
				<search position="before"><![CDATA[<?php foreach ($links as $link) { ?>]]></search>
				<add><![CDATA[
				
				<!--  Weblog -->
				
				<?php if (!empty($weblog_article)) { // First check if one of the following variables is set ?>

					<style>
					/*Fix the arrow > V at the right of the Weblog logo */
					#menu li#weblog li a.parent::after, #column-left.active #menu > li#weblog a.parent::after {
						position:relative;
						top: 5px;
					}
					
					#menu li#weblog > a,
					#menu li#weblog li a::before {color:#43D2F9;}
					#menu li li a.wl-article::before {content: "";}
					#menu li li a.wl-category::before {content: "";}
					#menu li li a.wl-author::before {content: "";}
					#menu li li a.wl-comment::before {content: "";}
					#menu li li a.wl-report::before {content: "";}
					#menu li li a.wl-setting::before {content: "";}
					#menu li li a.wl-backup::before {content: "";}
					
					#menu li#weblog li.active a:last-child::before {margin-left:10px;}
					#menu li#weblog li.active > a:last-child {color:#43D2F9;}
					</style>
				
					<script>
					$(function() {
					
						var $menu = $('#column-left ul#menu');
						
						var comments = '<?php if ($pending_reply_total) { ?><em style="margin-left:15px;color:lime;">+<b style="font-weight:normal; "><?php echo $pending_reply_total ?> <i class="fa fa-comments" aria-hidden="true"></i></b></em><?php } ?>'; 
						
						var html = '';
						
						html += '<li id="weblog"><a class="parent"><i class="fa fa-file-text-o fa-fw" aria-hidden="true"></i> <span><img style="width:80px" src="view/image/weblog-logo.gif" /><?php //echo $text_weblog; ?></span>' + comments + '</a>';
						html += 	'<ul>';
						html += 		'<li><a class="wl-article" href="<?php echo $weblog_article; ?>"><?php echo $text_weblog_article; ?></a></li>';
						html += 		'<li><a class="wl-category" href="<?php echo $weblog_category; ?>"><?php echo $text_weblog_category; ?></a></li>';
						html += 		'<li><a class="wl-author" href="<?php echo $weblog_author; ?>"><?php echo $text_weblog_author; ?></a></li>';
						html += 		'<li><a class="wl-comment" href="<?php echo $weblog_comment; ?>"><?php echo $text_weblog_article_comment; ?>' + comments + '</a></li>';
						html += 		'<li><a class="wl-report" href="<?php echo $weblog_view_report; ?>"><?php echo $text_weblog_view_report; ?></a></li>';
						html += 		'<li><a class="wl-setting parent" ><?php echo $text_weblog_setting; ?></a>';
						html += 			'<ul>';
						html += 				'<li><a href="<?php echo $weblog_general_setting; ?>"><?php echo $text_weblog_general_setting; ?></a></li>';
						html += 				'<li><a href="<?php echo $weblog_add_modules; ?>"><?php echo $text_weblog_add_modules; ?></a></li>';
						html +=				'</ul>';
						html += 		'</li>';
						html += 		'<li><a class="wl-backup" href="<?php echo $weblog_backup; ?>"><?php echo $text_weblog_backup; ?></a></li>';					
						html += 	'</ul>';
						html += '</li>';
						
						$menu.append(html);
				
					});
				
					</script>
				
				<?php } ?>
				
				<!-- END Weblog -->
				
				]]></add>
			</operation>
		</file>
		
		<!--
		<file name="admin/view/template/common/menu.tpl">
			<operation error="log">
				<search position="before"><![CDATA[<li id="system">]]></search>
				<add><![CDATA[
					<li id="weblog"><a class="parent" style="color:#23C1F0"><i class="fa fa-file-text-o fa-fw"></i> <span><?php echo $text_weblog; ?></span></a>
						<ul>
							<li><a href="<?php echo $weblog_article; ?>"><?php echo $text_weblog_article; ?></a></li>
							<li><a href="<?php echo $weblog_category; ?>"><?php echo $text_weblog_category; ?></a></li>
							<li><a href="<?php echo $weblog_author; ?>"><?php echo $text_weblog_author; ?></a></li>
							<li><a href="<?php echo $weblog_comment; ?>"><?php echo $text_weblog_article_comment; ?></a></li>
							<li><a href="<?php echo $weblog_view_report; ?>"><?php echo $text_weblog_view_report; ?></a></li>
							<li><a class="parent"><?php echo $text_weblog_setting; ?></a>
								<ul>
									<li><a href="<?php echo $weblog_general_setting; ?>"><?php echo $text_weblog_general_setting; ?></a></li>
									<li><a href="<?php echo $weblog_add_modules; ?>"><?php echo $text_weblog_add_modules; ?></a></li>
								</ul>
							</li>
						</ul>
					</li>
				]]></add>
			</operation>
		</file>
		-->

		
		<!-- Captcha option for Oc >= 2.1.0.1 -->
		<file name="admin/controller/setting/setting.php">
			<operation error="skip">
				<search position="after"><![CDATA[$data['captcha_pages'] = array();]]></search>
				<add><![CDATA[

					$data['captcha_pages'][] = array(
						'text'  => 'Weblog Comments',
						'value' => 'weblog_comment'
					);

				]]></add>
			</operation>
		</file>
	
	<!-- End ADMIN -->

	
	
	
	
	

<!--	
//   ██████╗ █████╗ ████████╗ █████╗ ██╗      ██████╗  ██████╗ 
//  ██╔════╝██╔══██╗╚══██╔══╝██╔══██╗██║     ██╔═══██╗██╔════╝ 
//  ██║     ███████║   ██║   ███████║██║     ██║   ██║██║  ███╗
//  ██║     ██╔══██║   ██║   ██╔══██║██║     ██║   ██║██║   ██║
//  ╚██████╗██║  ██║   ██║   ██║  ██║███████╗╚██████╔╝╚██████╔╝
//   ╚═════╝╚═╝  ╚═╝   ╚═╝   ╚═╝  ╚═╝╚══════╝ ╚═════╝  ╚═════╝ 
-->





		<!--
		//  ███████╗██╗████████╗███████╗███╗   ███╗ █████╗ ██████╗ 
		//  ██╔════╝██║╚══██╔══╝██╔════╝████╗ ████║██╔══██╗██╔══██╗
		//  ███████╗██║   ██║   █████╗  ██╔████╔██║███████║██████╔╝
		//  ╚════██║██║   ██║   ██╔══╝  ██║╚██╔╝██║██╔══██║██╔═══╝ 
		//  ███████║██║   ██║   ███████╗██║ ╚═╝ ██║██║  ██║██║     
		//  ╚══════╝╚═╝   ╚═╝   ╚══════╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝ 
		-->	
			<file name="catalog/controller/information/sitemap.php">
				
				<!-- Disable the old code -->
				<operation>
					<search position="after" error="log"><![CDATA[function index() {]]></search>				
					<add><![CDATA[
					
			// Weblog - Sitemap  
					
						$this->load->model('weblog/weblog');
					
						$weblog_sitemap_categories = array();
						

						
						if ( $this->config->get('weblog_status') ) {
	
					// Weblog main page	
					
							$weblog_texts = $this->config->get('weblog_texts');
							$data['weblog_text_link_name'] = !empty($weblog_texts[$this->config->get('config_language_id')]['weblog_text_link_name'])? $weblog_texts[$this->config->get('config_language_id')]['weblog_text_link_name'] : 'Blog';

							$weblog_sitemap_categories[] = array(
								'name'     => $data['weblog_text_link_name'],
								'children' => $weblog_sitemap_categories,
								'href'     => $this->url->link('weblog/article', 'weblog=' . $this->config->get('config_store_id'), 'SSL') // For the parameter weblog=..., see file Seo_url.php
							);	
							

					// Weblog Categories
					
							$category_total = $this->model_weblog_weblog->getTotalCategories();
							
							if ($category_total) {
								
								$weblog_categories = $this->model_weblog_weblog->getCategories();

								foreach ($weblog_categories as $category) {
										
									// Level 2
									$children_data = array();
									
									$filter_data = array(
										'parent_category_id' 	=> $category['weblog_category_id']
									);

									$children = $this->model_weblog_weblog->getCategories($filter_data);
									
									foreach ($children as $child) {
									
										$child_name = $child['name'];

										$children_data[] = array(
											'name'  => $child_name,
											'href'  => $this->url->link('weblog/category', 'weblog_category_path=' . $category['weblog_category_id'] . '_' . $child['weblog_category_id'])
										);					
									}
									
									// Level 1
									$weblog_sitemap_categories[] = array(
										'name'     => $category['name'],
										'children' => $children_data,
										'href'     => $this->url->link('weblog/category', 'weblog_category_path=' . $category['weblog_category_id'])
									);			
								}
							}	
						}
						
						$data['weblog_sitemap_categories'] = $weblog_sitemap_categories;
						
			// Weblog - Sitemap  

					]]></add>
				</operation>
			</file>
			
			
			<file name="catalog/view/theme/*/template/information/sitemap.tpl">
				
				<operation>
					<search position="before" error="log"><![CDATA[<?php echo $content_bottom; ?>]]></search>				
					<add><![CDATA[
					
					 <?php if ($weblog_sitemap_categories) { ?>
						<ul>
						
							<?php $weblog_link = array_shift($weblog_sitemap_categories); // the first element is the main Weblog page, get it and shift the array ?>

							<li>  <a href="<?php echo $weblog_link['href']; ?>"><?php echo $weblog_link['name']; ?> </li>
								<ul>
								<?php foreach ($weblog_sitemap_categories as $category_1) { ?>
									<li><a href="<?php echo $category_1['href']; ?>"><?php echo $category_1['name']; ?></a>
										<?php if (!empty($category_1['children'])) { ?>
										<ul>
											<?php foreach ($category_1['children'] as $category_2) { ?>
											<li><a href="<?php echo $category_2['href']; ?>"><?php echo $category_2['name']; ?></a></li>
											<?php } ?>
										</ul>
										<?php } ?>
									</li>
								<?php } ?>
								</ul>
							</li>
						</ul>
					<?php } ?>
	
					]]></add>
				</operation>
			</file>

		<!-- END SITEMAP -->
		
		
		
		
		<!--
		//  ███████╗███████╗███████╗██████╗     ██████╗ ███████╗███████╗
		//  ██╔════╝██╔════╝██╔════╝██╔══██╗    ██╔══██╗██╔════╝██╔════╝
		//  █████╗  █████╗  █████╗  ██║  ██║    ██████╔╝███████╗███████╗
		//  ██╔══╝  ██╔══╝  ██╔══╝  ██║  ██║    ██╔══██╗╚════██║╚════██║
		//  ██║     ███████╗███████╗██████╔╝    ██║  ██║███████║███████║
		//  ╚═╝     ╚══════╝╚══════╝╚═════╝     ╚═╝  ╚═╝╚══════╝╚══════╝
		-->
			<!--                           Oc <= 2.2.0.0                              Oc >= 2.3.0.2                   -->		
			<file error="skip" name="catalog/controller/feed/google_sitemap.php,catalog/controller/extension/feed/google_sitemap.php">
				
				<operation>
					<search position="before" error="log"><![CDATA[$output .= '</urlset>';]]></search>				
					<add><![CDATA[
					
					
						// Weblog
			
						if ( $this->config->get('weblog_status') ) {
						
							$this->load->model('weblog/weblog');
							
							// Weblog main page
							$output .= '<url>';
							$output .= '<loc>' . $this->url->link('weblog/article', 'weblog=' . $this->config->get('config_store_id'), 'SSL') . '</loc>';
							$output .= '<changefreq>weekly</changefreq>';
							$output .= '<priority>0.5</priority>';
							$output .= '</url>';
							
							
							// Weblog articles
							$filter_data = array(
								'start'		=> 0,
								'limit'		=> 9999999999,
								'sort'		=> 'wa.date_added',
								'order'		=> 'DESC'
							);
							$results = $this->model_weblog_weblog->getArticles($filter_data);
						
							if ($results) {
								foreach ($results as $result) {
								$output .= '<url>';
								$output .= '<loc>' . $this->url->link('weblog/article/view', 'weblog_article_id=' . $result['weblog_article_id'], 'SSL') . '</loc>';
								$output .= '<changefreq>weekly</changefreq>';
								$output .= '<priority>0.5</priority>';
								$output .= '</url>';
								}
							}
							
							
							// Weblog categories	
							$filter_data = array(
								'parent_category_id' => 0
							);
								
							$results = $this->model_weblog_weblog->getCategories($filter_data);

							if ($results) {
								foreach ($results as $result) {
											
									$output .= '<url>';
									$output .= '<loc>' . $this->url->link('weblog/category', 'weblog_category_path=' . $result['weblog_category_id'], 'SSL') . '</loc>';
									$output .= '<changefreq>weekly</changefreq>';
									$output .= '<priority>0.5</priority>';
									$output .= '</url>';
								}
							}
						}	
						// End Weblog

	
					]]></add>
				</operation>
			</file>
		
		<!-- END FEED RSS -->
	
	
	
	
		<!--
		//  ████████╗ ██████╗ ██████╗     ███╗   ███╗███████╗███╗   ██╗██╗   ██╗
		//  ╚══██╔══╝██╔═══██╗██╔══██╗    ████╗ ████║██╔════╝████╗  ██║██║   ██║
		//     ██║   ██║   ██║██████╔╝    ██╔████╔██║█████╗  ██╔██╗ ██║██║   ██║
		//     ██║   ██║   ██║██╔═══╝     ██║╚██╔╝██║██╔══╝  ██║╚██╗██║██║   ██║
		//     ██║   ╚██████╔╝██║         ██║ ╚═╝ ██║███████╗██║ ╚████║╚██████╔╝
		//     ╚═╝    ╚═════╝ ╚═╝         ╚═╝     ╚═╝╚══════╝╚═╝  ╚═══╝ ╚═════╝ 
		-->
			<file name="catalog/controller/common/header.php">
				
				<!-- Disable the old code -->
				<operation>
					<search position="before" error="log"><![CDATA[foreach ($categories as $category) {]]></search>
					<add><![CDATA[


						// This "if" generates the blog categories and the category list displayed in the dropdown menu under 
						// the blog link (the one in the product category menu bar). The dropdown menu contains only the top level
						// blog categories.
					
						$this->load->model('weblog/weblog');
					
						$weblog_menu_categories = array();
					
						if ( $this->config->get('weblog_status') && ($this->config->get('weblog_top_menu_link') || $this->config->get('weblog_display_menu') ) ) {
							$category_total = $this->model_weblog_weblog->getTotalCategories();
							
							if ($category_total) {
								
								$weblog_categories = $this->model_weblog_weblog->getCategories();

								foreach ($weblog_categories as $category) {
									
									if ($category['top']) {
										// Level 2
										$children_data = array();
										
										$filter_data = array(
											'parent_category_id' 	=> $category['weblog_category_id']
										);

										$children = $this->model_weblog_weblog->getCategories($filter_data);
										
										foreach ($children as $child) {
											
											if ($this->config->get('weblog_category_article_count')) {
											
												$filter_data = array(
													'weblog_category_id'	=> $child['weblog_category_id']
												);
				
												$article_total = $this->model_weblog_weblog->getTotalArticles($filter_data);
							
												$child_name = $child['name'] . ' (' . $article_total . ')';
											} else {
												$child_name = $child['name'];
											}
							
											$children_data[] = array(
												'name'  => $child_name,
												'href'  => $this->url->link('weblog/category', 'weblog_category_path=' . $category['weblog_category_id'] . '_' . $child['weblog_category_id'])
											);					
										}
										
										// Level 1
										$weblog_menu_categories[] = array(
											'name'     => $category['name'],
											'children' => $children_data,
											'column'   => $category['column'] ? $category['column'] : 1,
											'href'     => $this->url->link('weblog/category', 'weblog_category_path=' . $category['weblog_category_id'])
										);			
									}
								}
							}	
						}
					

						$route = array();
						
						$route = isset($this->request->get['route'])? explode("/", $this->request->get['route']) : array();
						
						// Display blog categories instead of product categories in the menu bar
						if ( $this->config->get('weblog_status') && $this->config->get('weblog_display_menu') && isset($route[0]) && $route[0] == 'weblog' ) {

							$data['categories'] = $weblog_menu_categories;
						}
						else // this "else" disables following "for" statement, curly braces aren't necessary
						
					]]></add>
				</operation>
				
				<operation>
					<search position="before" regex="true" index="1"><![CDATA[/(if [(]file_exists[(]DIR_TEMPLATE|return [$]this[-][>]load[-][>]view)/]]></search>
					<add><![CDATA[
                                                                                                                       //  home page without route=common/home 
						if ( ($this->config->get('weblog_status') && $this->config->get('weblog_top_menu_link')) && (      !isset($route[0])                      || !$this->config->get('weblog_display_menu') || (isset($route[0]) && $route[0] != 'weblog')) ) {
	
							$weblog_texts = $this->config->get('weblog_texts');

							$data['weblog_text_link_name'] = !empty($weblog_texts[$this->config->get('config_language_id')]['weblog_text_link_name'])? $weblog_texts[$this->config->get('config_language_id')]['weblog_text_link_name'] : 'Blog';

							$weblog_link = array(
								'name'     => $data['weblog_text_link_name'],
								'children' => $weblog_menu_categories,
								'column'   => 1,
								'href'     => $this->url->link('weblog/article', 'weblog=' . $this->config->get('config_store_id'), 'SSL') // For the parameter weblog=..., see file Seo_url.php
							);	
						
							$position = $this->config->get('weblog_top_menu_link_position');
						
							if ($position == 'first') {
								array_unshift($data['categories'], $weblog_link);
							} else {
								$data['categories'][] = $weblog_link;
							}
						}
	
					]]></add>
				</operation>
				
				<!-- Set the template name, see header.tpl there is a css fix for the breadcrumbs (default template) -->
				<operation>
					<search position="after"><![CDATA[function index() {]]></search>
					<add><![CDATA[
 
						if ( version_compare(VERSION, '2.0.0.0', '>=')) {
							$data['template_name'] = $this->config->get('config_template');
						} else {
							$this->data['template_name'] = $this->config->get('config_template');
						}
					]]></add>
				</operation>	
			</file>
			
			<!-- Breadcrumb css fix, OC 2+ default theme: prevent breadcrumbs overlapping on small screen devices -->
			<file name="catalog/view/theme/*/template/common/header.tpl">
				<operation>
					<search position="before" error="skip"><![CDATA[</head>]]></search>
					<add><![CDATA[
						<?php if (!empty($template_name) && $template_name  == 'default' && version_compare(VERSION, '2.0.0.0', '>=')) { ?>
							<style>
								.breadcrumb {padding:0;}
								.breadcrumb > li {padding:10px 20px;}
								.breadcrumb > li::after {top:7px;}
							</style>
						<?php } ?>
					]]></add>
				</operation>
			</file>	
			
		
		
		
		<!--
		//  ███████╗ ██████╗  ██████╗ ████████╗███████╗██████╗     ██╗     ██╗███╗   ██╗██╗  ██╗
		//  ██╔════╝██╔═══██╗██╔═══██╗╚══██╔══╝██╔════╝██╔══██╗    ██║     ██║████╗  ██║██║ ██╔╝
		//  █████╗  ██║   ██║██║   ██║   ██║   █████╗  ██████╔╝    ██║     ██║██╔██╗ ██║█████╔╝ 
		//  ██╔══╝  ██║   ██║██║   ██║   ██║   ██╔══╝  ██╔══██╗    ██║     ██║██║╚██╗██║██╔═██╗ 
		//  ██║     ╚██████╔╝╚██████╔╝   ██║   ███████╗██║  ██║    ███████╗██║██║ ╚████║██║  ██╗
		//  ╚═╝      ╚═════╝  ╚═════╝    ╚═╝   ╚══════╝╚═╝  ╚═╝    ╚══════╝╚═╝╚═╝  ╚═══╝╚═╝  ╚═╝
		-->
			<file name="catalog/controller/common/footer.php">
				<operation>
					<search position="after"><![CDATA[$data['powered']]]></search>
					<add><![CDATA[
					
						$data['weblog_status'] = $this->config->get('weblog_status');
						$data['weblog_footer_link'] = $this->config->get('weblog_footer_link');

						if ( $this->config->get('weblog_status') && $this->config->get('weblog_footer_link') ) {
						
							$weblog_texts = $this->config->get('weblog_texts');

							$data['weblog_text_link_name'] = !empty($weblog_texts[$this->config->get('config_language_id')]['weblog_text_link_name'])? $weblog_texts[$this->config->get('config_language_id')]['weblog_text_link_name'] : 'Blog';

							$data['weblog']	= $this->url->link('weblog/article', 'weblog=' . $this->config->get('config_store_id'), 'SSL'); // For the parameter weblog=store_id, see file Seo_url.php
						}
					]]></add>
				</operation>
			</file>
			
		
			<file name="catalog/language/*/common/footer.php">
				<operation>
					<search position="after"><![CDATA[$_['text_powered']]]></search>
					<add><![CDATA[
						$_['text_weblog']   = 'Blog'; // It also works for the top bar menu
					]]></add>
				</operation>
			</file>
		
		
			<file name="catalog/view/theme/*/template/common/footer.tpl">
				<operation error="skip">
					<search position="after" error="skip"><![CDATA[<?php echo $special; ?>]]></search>
					<add><![CDATA[
						<?php if ( $weblog_status && $weblog_footer_link ) { ?>
							<li><a href="<?php echo $weblog; ?>"><?php echo $weblog_text_link_name; ?></a></li>
						<?php } ?>
					]]></add>
				</operation>
			</file>	
			
		
		
		
		
		<!--
		//  ███████╗███████╗ ██████╗     ██╗   ██╗██████╗ ██╗     
		//  ██╔════╝██╔════╝██╔═══██╗    ██║   ██║██╔══██╗██║     
		//  ███████╗█████╗  ██║   ██║    ██║   ██║██████╔╝██║     
		//  ╚════██║██╔══╝  ██║   ██║    ██║   ██║██╔══██╗██║     
		//  ███████║███████╗╚██████╔╝    ╚██████╔╝██║  ██║███████╗
		//  ╚══════╝╚══════╝ ╚═════╝      ╚═════╝ ╚═╝  ╚═╝╚══════╝
		-->
			<!--
			Oc <  2.2.0.0 : catalog/controller/common/seo_url.php,
			Oc >= 2.2.0.0 : catalog/controller/startup/seo_url.php
			-->
			<file name="catalog/controller/common/seo_url.php,catalog/controller/startup/seo_url.php" error="skip">
			
				<!-- Check if Weblog SEO path is present, if so, we will prepend it to any Weblog page -->
				<operation error="log">
					<search position="before"><![CDATA[foreach ($parts as $part) {]]></search>
					<add><![CDATA[ 
	
					if (isset($parts[0]) && $parts[0] == $this->config->get('weblog_seo_path')) {

						array_shift($parts); // remove the element $parts[0] by shifting the array (do not use unset($parts[0]) because the index 0 would get lost)		
					}
					
					if (isset($parts[0]) && $parts[0] == 'author') { // After shifting the array, $parts[1] (if it's set) becomes $parts[0]
						array_shift($parts);
					}
					
					$weblog_search_path = ($this->config->get('weblog_seo_path')?  $this->config->get('weblog_seo_path') . '/wlsearch' : 'wlsearch');
				
					if ($this->request->get['_route_'] == $weblog_search_path){
						$this->request->get['route'] = 'weblog/search';
					}
					
					if ($this->request->get['_route_'] != $weblog_search_path) // No need of braces

					]]></add>
				</operation>
				
				<operation error="log">
					<search position="after"><![CDATA[public function rewrite($link) {]]></search>
					<add><![CDATA[ 														
						$weblog_path = $this->config->get('weblog_seo_path')? '/' . $this->config->get('weblog_seo_path') : '';
					]]></add>
				</operation>
			

			<!-- 
			Example of rows ( Db table url_alias):
			
             ___________________________________________________________________ 
			|  Url_alias_id   |           Query             |   Keyword         |      ROUTES
			|_________________|_____________________________|___________________|
			|       45        |   weblog_article_id  = 2    |   my-article-uri  |      weblog/article/view   
			|_________________|_____________________________|___________________|
			|       46        |   weblog_category_path = 5    |   my-cat-uri      |      weblog/category
			|_________________|_____________________________|___________________|
			|       47        |   weblog_author_id   = 1    |   john-doe        |      weblog/author
			|_________________|_____________________________|___________________|
			                            ^            ^                       
		                             url[0]       url[1]                    
				 
			After we have found the query related to the given keyword, Set routes and element ids 
			-->
			<operation error="log">
				<search position="after" offset="-2"><![CDATA[$this->request->get['route'] = 'error/not_found';]]></search>
				<add><![CDATA[ 
				

					if ($url[0] == 'weblog_article_id') {
					
						$this->request->get['route'] = 'weblog/article/view';
						$this->request->get['weblog_article_id'] = $url[1];						
					}
					
					if ($url[0] == 'weblog_category_id') {
					
						if (!isset($this->request->get['weblog_category_path'])) {
							
							$this->request->get['route'] = 'weblog/category';
							$this->request->get['weblog_category_path'] = $url[1];
						} else {
						
							$this->request->get['route'] = 'weblog/category';
							$this->request->get['weblog_category_path'] .= '_' . $url[1];
						}
					}
					 
					if ($url[0] == 'weblog_author_id') { 
					
						$this->request->get['route'] = 'weblog/author';
						$this->request->get['weblog_author_id'] = $url[1];
					}
					
					// Set up the route for the article list page 
					
					if ($url[0] == 'weblog') { 
					
						$this->request->get['route'] = 'weblog/article';
						$this->request->get['weblog'] = 1;
					}				
				]]></add>
			</operation>

			
			<!-- URL rewrite for articles and Weblog categories -->
			<operation error="log">
				<search position="replace"><![CDATA[} elseif ($key == 'path') {]]></search>
				<add><![CDATA[

					} else if($data['route'] == 'weblog/article/view' && $key == 'weblog_article_id') {
					
						// Prepend to the article name the current category path
						$cat_path = '';
						if( isset($data['weblog_category_path'])) {
						
							$weblog_categories = explode("_", $data['weblog_category_path']);

							foreach ($weblog_categories as $weblog_category) {
								$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = 'weblog_category_id=" . (int)$weblog_category . "'");
								
								if ($query->num_rows && $query->row['keyword']) {
								
									$cat_path .= '/' . $query->row['keyword']; // APPEND CHILD CATEGORY NAMES TO THEIR PARENTS, 	
								}
							}
							unset($data['weblog_category_path']);
						}
					

						$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = '" . $this->db->escape($key . '=' . (int)$value) . "'");
						
						if ($query->num_rows && $query->row['keyword']) {
							$url .= $weblog_path .  $cat_path . '/' .  $query->row['keyword'];
							$url .= isset($url_info['fragment'])? '#' . $url_info['fragment'] : ''; // string after the hashmark #
						} 
						unset($data[$key]);
 
					} else if($data['route'] == 'weblog/author' && $key == 'weblog_author_id') {
					
						$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = '" . $this->db->escape($key . '=' . (int)$value) . "'");
						
						if ($query->num_rows && $query->row['keyword']) {
						
							$url .= $weblog_path . '/author/' . $query->row['keyword'];
							$url .= isset($url_info['fragment'])? '#' . $url_info['fragment'] : ''; // string after the hashmark #
						} 
						unset($data[$key]);
						
					} else if($data['route'] == 'weblog/category' && $key == 'weblog_category_path') {
					
						$weblog_categories = explode("_", $value);

						$tmp = '';
						foreach ($weblog_categories as $weblog_category) {
							$query = $this->db->query("SELECT * FROM " . DB_PREFIX . "url_alias WHERE `query` = 'weblog_category_id=" . (int)$weblog_category . "'");
							
							if ($query->num_rows && $query->row['keyword']) {
							
								$tmp .= '/' . $query->row['keyword']; // APPEND CHILD CATEGORY NAMES TO THEIR PARENTS, 	
							}
						}
						$url .= !empty($tmp)? ($weblog_path . $tmp . '/') : ''; // Add a trailing slash to the last category name
						
						$url .= isset($url_info['fragment'])? '#' . $url_info['fragment'] : ''; // string after the hashmark #
						
						unset($data[$key]);
											
					} else if($data['route'] == 'weblog/search') {
						
						$url .= $weblog_path . '/wlsearch';
						
						$url .= isset($url_info['fragment'])? '#' . $url_info['fragment'] : ''; // string after the hashmark #
						
						unset($data[$key]);

					} else if ( isset($data['route']) && $data['route'] == 'weblog/article' && $key == 'weblog' ) {
						
						$url .= $weblog_path;
						
						if ($this->config->get('weblog_seo_keyword')) {
							$url .= '/' . $this->config->get('weblog_seo_keyword');			
						} else {
							$url =  '';
						}
						$url .= isset($url_info['fragment'])? '#' . $url_info['fragment'] : ''; // string after the hashmark #
						
						unset($data['weblog']); // "dummy" parameter passed from the route weblog/article to identify itself. Remove it so it will not be appended to the url.
					} 

					elseif ($key == 'path') {			
					
				]]></add>
			</operation>
		</file>	
	
	<!-- End CATALOG -->
	
</modification>